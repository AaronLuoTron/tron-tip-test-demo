<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>window.tron</title>
</head>
<body>
  <div class="sign" id="sign">
    <button id="get-account-info">eth_requestAccounts</button>
  </div>
  <script>
    function createTransferElement(prefix) {
      const dom = `
        <div style="border: 1px solid #ddd; padding: 10px;margin-top: 20px;">
          <p style="margin: 5px 0;">test tron.tronWeb sign ${prefix} transfer</p>
          <label for="${prefix}-sign-address">to Address</label>
          <input id="${prefix}-sign-address" type="text" />
          <br/>
          <label for="${prefix}-sign-token">Token</label>
          <select id="${prefix}-sign-token" name="" id="">
            <option value="${prefix}">${prefix}</option>
          </select>
          <br/>
          ${(() => {
            if (prefix === 'trc10') {
              return `
                <label for="${prefix}-sign-trc10-id">trc10 token id</label>
                <input id="${prefix}-sign-trc10-id" type="text" />
                <br/>
              `
            }
          })()}
          <label for="${prefix}-sign-amount">Amount</label>
          <input id="${prefix}-sign-amount" type="text" />
          <br/>
          <button id="${prefix}-sign-trade-btn">submit ${prefix} trade</button>
        </div>
      `;
      document.getElementById('sign').innerHTML += dom;
    }
  </script>
  <script>
    const log = console.log.bind(console, '=====window.tron CONSOLE=====');
    createTransferElement('trx');
    createTransferElement('trc10');
    createTransferElement('trc20');

    window.onload = () => {
      // todos should not listener like this
      setTimeout(() => {
        log(window.tron);
        window.tron.on('connect', (...args) => {
          log('tronProviderEvent - connect', ...args);
        })

        window.tron.on('disconnect', (...args) => {
          log('tronProviderEvent - disconnect', ...args);
        })

        window.tron.on('chainChanged', (...args) => {
          log('tronProviderEvent - chainChanged', ...args);
        })

        window.tron.on('accountsChanged', (...args) => {
          log('tronProviderEvent - accountsChanged', ...args);
        })
      }, 1000);
      
      // eth_requestAccounts
      document.getElementById('get-account-info').addEventListener('click', async () => {
        try {
          const res = await tron.request({method: 'eth_requestAccounts'});
          log('eth_requestAccounts success', res);
          if (utils.isArray(res) && typeof res[0] === 'string') {
            log('eth_requestAccounts success');
          }
        } catch (error) {
          log('eth_requestAccounts fail', error);
        }
      })

      window.tron.on('connect', (...args) => {
        if (window.tron && window.tron.tronWeb && window.tron.tronWeb.ready) {
          // trx sign
          // Triggering the "sign-trade" button must be able to evoke the signature function of the wallet
          document.getElementById('trx-sign-trade-btn').addEventListener('click', async () => {
            log('enter trx-sign-trade-btn');
            const toAddressInput = document.getElementById('trx-sign-address');
            const tokenSelect = document.getElementById('trx-sign-token');
            const amountInput = document.getElementById('trx-sign-amount');

            const toAddress = toAddressInput.value;
            const amount = amountInput.value;

            transaction = await tron.tronWeb.transactionBuilder.sendTrx(
              toAddress,
              amount * 1000000,
            );
            signedTransaction = await tron.tronWeb.trx.sign(transaction);
            res = await tron.tronWeb.trx.sendRawTransaction(signedTransaction);
          });

          // trc10 sign
          // Triggering the "sign-trade" button must be able to evoke the signature function of the wallet
          document.getElementById('trc10-sign-trade-btn').addEventListener('click', async () => {
            log('enter trc10-sign-trade-btn', 'contract address: TXKgW7Ai5KkSKr7Jfxn4AZRpB3BZusHJLj');
            const toAddressInput = document.getElementById('trc10-sign-address');
            const trc10id = document.getElementById('trc10-sign-trc10-id');
            const tokenSelect = document.getElementById('trc10-sign-token');
            const amountInput = document.getElementById('trc10-sign-amount');

            const toAddress = toAddressInput.value;
            const amount = amountInput.value;
            const trc10idValue = trc10id.value;

            tron.tronWeb.trx.sendToken(toAddress, amount * 1000000, trc10idValue);
          });

          // trc20 sign
          // Triggering the "sign-trade" button must be able to evoke the signature function of the wallet
          document.getElementById('trc20-sign-trade-btn').addEventListener('click', async () => {
            log('enter trc20-sign-trade-btn', 'contract address: TXKgW7Ai5KkSKr7Jfxn4AZRpB3BZusHJLj');
            const toAddressInput = document.getElementById('trc20-sign-address');
            const tokenSelect = document.getElementById('trc20-sign-token');
            const amountInput = document.getElementById('trc20-sign-amount');

            const toAddress = toAddressInput.value;
            const amount = amountInput.value;

            contractInstance = await tron.tronWeb.contract().at('TXKgW7Ai5KkSKr7Jfxn4AZRpB3BZusHJLj');
            transaction = await contractInstance.transfer(toAddress, amount * Math.pow(10, 12)).send();
          });
        }
      })
      
    }

    // todos multiSign
  </script>
</body>
</html>